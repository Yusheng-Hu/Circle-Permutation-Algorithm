name: Circle Permutation Benchmark

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  benchmark:
    name: Run Circle Permutation Profiling
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        # Fetches the source code from the repository
        uses: actions/checkout@v4

      - name: Get CPU Hardware Info
        # Logs the specific CPU model used by the GitHub runner
        run: |
          MODEL=$(lscpu | grep "Model name" | cut -d':' -f2 | xargs)
          echo "CPU_MODEL=$MODEL" >> $GITHUB_ENV

      - name: Compile Circle Algorithm
        # Compile with aggressive optimization flags for maximum performance
        run: |
          g++ -O3 -std=c++11 -march=native -flto -ffast-math -fomit-frame-pointer \
          Circle_Permutation_Algorithm.cpp -o circle_test -pthread

      - name: Execute and Capture Results
        # Runs the binary and saves output to a file while showing it in real-time
        run: |
          ./circle_test | tee run_log.txt
          # Extract the execution time from the line containing RESULT_TIME
          TIME_VAL=$(grep "RESULT_TIME" run_log.txt | awk '{print $2}')
          echo "TIME_CIRCLE=$TIME_VAL" >> $GITHUB_ENV

      - name: Generate Summary Report
        # Creates a Markdown table in the GitHub Action Summary page
        if: always()
        run: |
          echo "### ðŸš€ Performance Benchmark Report" >> $GITHUB_STEP_SUMMARY
          echo "| Algorithm | Execution Time | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          # Handle cases where time might be missing
          if [ -n "${{ env.TIME_CIRCLE }}" ]; then
            echo "| Circle Permutation | \`${{ env.TIME_CIRCLE }} s\` | Completed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Circle Permutation | \`N/A\` | Failed/Timeout |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ’» Environment Information" >> $GITHUB_STEP_SUMMARY
          echo "- **CPU Model:** ${{ env.CPU_MODEL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Optimizations:** \`-O3 -march=native -flto\`" >> $GITHUB_STEP_SUMMARY
